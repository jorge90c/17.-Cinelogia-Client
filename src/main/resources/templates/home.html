<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="es"
      th:replace="~{layout :: layout}">
<body>
<div th:fragment="contenido">

    <div id="carouselPeliculas" class="carousel slide mb-5" data-bs-ride="carousel">
        <div class="carousel-inner">

           
            <div th:each="pelicula, iterStat : ${peliculas}"
                th:class="'carousel-item' + (${iterStat.index} == 0 ? ' active' : '')">

                
                <a th:href="@{'/peliculas/' + ${pelicula.id}}">
                    <img th:src="${pelicula.imagenPortada != null ? pelicula.imagenPortada : 'https://placehold.co/1200x400?text=SIN_FOTO'}"
                        class="d-block w-100"
                        style="height:400px; object-fit:cover;" 
                        th:alt="${pelicula.titulo}">
                </a>

           
                <div class="carousel-caption d-none d-md-block bg-dark bg-opacity-50 rounded p-2">
                    <h5 th:text="${pelicula.titulo}"></h5>
                    <p>
                        <span th:text="${pelicula.anio}"></span> ‚Äî
                        <span th:text="${pelicula.pais}"></span>
                    </p>
                </div>
            </div>

        </div>

        <!-- Controles -->
        <button class="carousel-control-prev" type="button" data-bs-target="#carouselPeliculas" data-bs-slide="prev">
            <span class="carousel-control-prev-icon"></span>
        </button>
        <button class="carousel-control-next" type="button" data-bs-target="#carouselPeliculas" data-bs-slide="next">
            <span class="carousel-control-next-icon"></span>
        </button>
    </div>

    <!-- ============================
        LISTADO DE PEL√çCULAS
    ============================= -->
    <div class="container mt-5">

        <h2 class="text-warning mb-4">Pel√≠culas</h2>

        <div class="row g-4">

            <div class="col-12" th:each="pelicula : ${peliculas}">
                <div class="card bg-dark text-light shadow-sm p-3">

                    <div class="row">

                    
                        <div class="col-md-4 d-flex">

                            <!-- Imagen -->
                            <img th:src="${pelicula.imagenPortada != null ? pelicula.imagenPortada : 'https://placehold.co/200x250?text=SIN_FOTO'}"
                                class="me-3 rounded"
                                style="width:120px; height:160px; object-fit:cover;">

                            <!-- Datos -->
                            <div>
                                <h5 class="text-warning mb-2" th:text="${pelicula.titulo}"></h5>

                                <p class="small mb-1">
                                    <strong>A√±o:</strong> <span th:text="${pelicula.anio}"></span><br>
                                    <strong>Pa√≠s:</strong> <span th:text="${pelicula.pais}"></span><br>
                                    <strong>Duraci√≥n:</strong> <span th:text="${pelicula.duracion}"></span> min<br>
                                    <strong>Direcci√≥n:</strong> <span th:text="${pelicula.direccion}"></span>
                                    <br>
                                    <strong>Actores:</strong>
                                        <span th:each="actor, iterStat : ${pelicula.actores}">
                                            <span th:text="${actor.nombre}"></span><span th:if="${!iterStat.last}">, </span>
                                        </span>
                                    <br>
                                    <strong>Nota media:</strong>
                                        <span th:if="${promedioPorPelicula[pelicula.id] != null}"
                                            th:text="${#numbers.formatDecimal(promedioPorPelicula[pelicula.id], 1, 1)}"></span>
                                        <span th:if="${promedioPorPelicula[pelicula.id] == null}">-</span>
                                </p>

                                <!-- Sinopsis corta -->
                                <p class="small text-muted"
                                th:text="${#strings.length(pelicula.sinopsis) > 120 ? #strings.substring(pelicula.sinopsis,0,120) + '...' : pelicula.sinopsis}">
                                </p>
                            </div>

                        </div>

                    
                        <div class="col-md-8">

                            <!-- Bot√≥n a√±adir comentario -->
                            <div class="d-flex mb-2">
                                <a th:href="@{'/reviews/nuevo/' + ${pelicula.id}}"
                                class="btn btn-warning btn-sm">‚ûï A√±adir comentario</a>
                            </div>

                            <!-- T√≠tulo comentarios -->
                            <h6 class="text-info">Comentarios</h6>

                            
                            <!-- Lista de comentarios -->
                                <div class="reviews" th:if="${reviewsPorPelicula[pelicula.id] != null}">
                                    <div th:each="review : ${reviewsPorPelicula[pelicula.id]}" class="border-bottom pb-2 mb-2">
                                        <p class="mb-1">
                                            <strong>Usuario:</strong>
                                            <span th:text="${review.usuario.username}"></span>
                                        </p>

                                        <p class="mb-1">
                                            <strong>Valoraci√≥n:</strong>
                                            <span th:text="${review.valoracion}"></span>
                                        </p>

                                        <p class="mb-1">
                                            <strong>Nota:</strong>
                                            <span th:text="${review.nota}"></span>/10
                                        </p>

                                        <p class="mb-1">
                                            <strong>Fecha de registro:</strong>
                                            <span th:text="${review.fecha}"></span>
                                        </p>

                                        
                                        <form th:action="@{'/reviews/eliminar/' + ${review.idReviews}}"
                                            method="post"
                                            sec:authorize="isAuthenticated()"
                                            th:if="${#authentication.name == review.usuario.correo}">
                                            <button class="btn btn-danger btn-sm mt-1">üóë Eliminar</button>
                                        </form>

                                    </div>
                                </div>

                                
                                <p th:if="${#lists.isEmpty(reviewsPorPelicula[pelicula.id])}"
                                class="text-muted small">
                                    No hay comentarios para esta pel√≠cula.
                                </p>

                        </div>

                    </div>

                </div>
            </div>

        </div>
    </div>



</div>
</body>
</html>
